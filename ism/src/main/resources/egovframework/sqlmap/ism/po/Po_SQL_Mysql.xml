<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ISM">

    <typeAlias  alias="ismwhs010VO" 		type = "nfm.com.whs.service.Ismwhs010VO"/>
    <typeAlias  alias="ismbyc010VO" 		type = "nfm.com.byc.service.Ismbyc010VO"/>
    <typeAlias  alias="ismpoo010SearchVO" 	type = "nfm.com.po.service.Ismpoo010VO"/>
    <typeAlias  alias="ismpol010VO" 		type = "nfm.com.po.service.Ismpol010VO"/>
    <typeAlias  alias="ismpoo010VO" 		type = "nfm.com.po.service.Ismpoo010VO"/>
    <typeAlias  alias="ismpoo020VO" 		type = "nfm.com.po.service.Ismpoo020VO"/>
    <typeAlias  alias="ismpom010VO" 		type = "nfm.com.po.service.Ismpom010VO"/>

    <typeAlias  alias="ismpomsearch020VO"	type = "nfm.com.po.service.Ismpomsearch020VO"/>
    <typeAlias  alias="ismpom020VO"			type = "nfm.com.po.service.Ismpom020VO"/>
    <typeAlias  alias="ismbyc020VO" 		type = "nfm.com.byc.service.Ismbyc020VO"/>

    <!-- 창고 목록 select -->
    <select id="po010DAO.selectWhsList" resultClass="ismwhs010VO">
	select a.*
		  , (select max(subb.uploaddate)
				from ismpol010 subb 
				where subb.poo010id = a.whs010id 
					and subb.pocotype = 'W') as uploaddate
	      , (select count(1) totcnt
		      from ismodm010 a
		           left outer join ismcum040 bb on a.cum030id = bb.cum030id and a.orderitemid = bb.cumprodcode and a.orderitemopt = bb.cumprodoptnm1
		           left outer join ismprd010 d on bb.orderitemid = d.itemcode
		           left outer join ismbyc010 e on d.byc010id = e.byc010id
		           left outer join LETTCCMMNDETAILCODE f on a.status = f.CODE and f.CODE_ID = 'ISM050'
		           
		           left outer join LETTCCMMNDETAILCODE j on a.claimstatus = j.CODE and j.CODE_ID = 'ISM060'
		           left outer join LETTCCMMNDETAILCODE k on a.claimreason = k.CODE and k.CODE_ID = 'ISM070'
		           left outer join LETTCCMMNDETAILCODE l on a.retstatus   = l.CODE and l.CODE_ID = 'ISM080'
		           left outer join (SELECT orderno, orderdate, cum010id, cum030id, byc010id, orderuser, orderusercontact, rcvuser, rcvusercontact, orderitemid, orderitemopt, orderitemqty, orderitembyprice, orderitemprice, postno, address, orderitemname
						, COUNT(1) chkcnt, sum(case when status = '' then 0 else 1 end ) chksum
					FROM ismodm010
					GROUP BY orderno, orderdate, cum010id, cum030id, byc010id, orderuser, orderusercontact, rcvuser, rcvusercontact, orderitemid, orderitemopt, orderitemqty, orderitembyprice, orderitemprice, postno, address, orderitemname
					HAVING COUNT(1) > 1
		            ) x  on a.orderno           = x.orderno           and a.orderdate         = x.orderdate         and a.cum010id          = x.cum010id          
						and a.cum030id          = x.cum030id          and a.byc010id          = x.byc010id          and a.orderuser         = x.orderuser         and a.orderusercontact  = x.orderusercontact  
						and a.rcvuser           = x.rcvuser           and a.rcvusercontact    = x.rcvusercontact    and a.orderitemid       = x.orderitemid       and a.orderitemopt      = x.orderitemopt      
						and a.orderitemqty      = x.orderitemqty      and a.orderitembyprice  = x.orderitembyprice  and a.orderitemprice    = x.orderitemprice    and a.postno            = x.postno            
						and a.address           = x.address           and a.orderitemname     = x.orderitemname,
		           
		           ismcum010 b left outer join LETTCCMMNDETAILCODE h on b.cotype2 = h.CODE and h.CODE_ID in ('ISM031','ISM032')
		                       left outer join LETTCCMMNDETAILCODE i on b.cotype3 = i.CODE and i.CODE_ID in ('ISM041','ISM042','ISM043','ISM044'),
		           LETTCCMMNDETAILCODE c, ismcum030 g
		     where a.cum010id = b.cum010id
		       and a.cum030id = g.cum030id
		       and b.cotype1 = c.CODE
		       and c.CODE_ID = 'ISM020'
			   and a.status = '1'
			   and d.pristock = a.whs010id and IFNULL(d.itemgubun,'1') in ('2')) as pocnt
      from ismwhs010 a
     where 1 = 1
     order by a.whsgubun, a.whsname
    </select>

    <!-- 매입처 목록 select -->
    <select id="po010DAO.selectBycList" resultClass="ismbyc010VO">
	select a.*,
           (select max(subb.uploaddate) from ismpol010 subb where subb.poo010id = a.byc010id and subb.pocotype = 'B') as uploaddate,
           (select count(*) from ismodm010 suba, ismcum040 subb, ismprd010 subc
             where suba.orderitemid = subb.cumprodcode 
               and suba.cum030id = subb.cum030id
               and subb.orderitemid = subc.itemcode
               and subc.byc010id = a.byc010id 
               and suba.status = 1 and IFNULL(subc.itemgubun,'1') in ('1','3')) pocnt
      from ismbyc010 a
     where 1 = 1
		and a.useyn = 'Y'
     order by a.bycname
    </select>

    <!-- 발주처 발주환경 설정 목록 select -->
    <select id="po010DAO.selectPoo010List" parameterClass="ismpoo010SearchVO" resultClass="ismpoo010VO">
    	select poo010id, pocotype, isassign, orderfield, orderfieldnm, fieldorder
    	from (
		    select IFNULL(b.poo010id,0) as poo010id
		    		, b.pocotype, IFNULL(b.isassign,'N') as isassign
		    		,CASE POSITION('additem' IN IFNULL(b.orderfield, a.CODE))
					 	WHEN 0 THEN IFNULL(b.orderfield, a.CODE)
						WHEN 1 THEN CONCAT_WS('@', orderfield, fieldname, fieldvalue)
					 END as orderfield
		    		, a.CODE_NM as orderfieldnm
		    		, IFNULL(fieldorder, 1000) as fieldorder
		      from LETTCCMMNDETAILCODE a left outer join ismpoo010 b
		           on a.CODE = b.orderfield and  b.poo010id = #poo010id# and b.pocotype = #pocotype#
		     where a.CODE_ID = 'ISM010'
		     	and a.use_at = 'Y'
		     union
		     select IFNULL(b.poo010id,0) as poo010id
		     		, b.pocotype, IFNULL(b.isassign,'N') as isassign
		     		,CASE POSITION('additem' IN IFNULL(b.orderfield, a.CODE))
					 	WHEN 0 THEN IFNULL(b.orderfield, a.CODE)
						WHEN 1 THEN CONCAT_WS('@', orderfield, fieldname, fieldvalue)
					 END as orderfield
		     		, b.fieldname as orderfieldnm
		     		, IFNULL(fieldorder, 1000) as fieldorder
		      from LETTCCMMNDETAILCODE a left outer join ismpoo010 b
		           on a.CODE = b.orderfield and  b.poo010id = #poo010id# and b.pocotype = #pocotype#
		     where a.CODE_ID = 'ISM0B0'
		     	and a.use_at = 'Y'
		     	and b.isassign = 'Y'
		 ) a order by fieldorder asc 
    </select>
    
	<delete id="po010DAO.deletePoo010" parameterClass="ismpoo010VO">
	delete from ismpoo010
	 where poo010id = #poo010id#
	   and pocotype = #pocotype#
	</delete>

	<insert id="po010DAO.insertPoo010" parameterClass="ismpoo010VO">
	insert into ismpoo010 (poo010id, pocotype, isassign, orderfield, fieldorder, fieldvalue, fieldname)
	               values (#poo010id#, #pocotype#, #isassign#, #orderfield#, #fieldorder#, #fieldvalue#, #fieldname#)
	</insert>

	<insert id="po010DAO.insertPoo020" parameterClass="ismpoo020VO">
	insert into ismpoo020 (byc010id, apiurl, apicontext, apiversion)
	               values (#byc010id#, #apiurl#, #apicontext#, #apiversion#)
	</insert>

	<update id="po010DAO.updatePoo020" parameterClass="ismpoo020VO">
	update ismpoo020 set apiurl = #apiurl#, apicontext = #apicontext#, apiversion = #apiversion#
	 where byc010id = #byc010id#
	</update>

	<select id="po010DAO.selectPoo020" parameterClass="int" resultClass="ismpoo020VO">
	select a.byc010id, a.apiurl, a.apicontext, a.apiversion
      from ismpoo020 a
     where a.byc010id = #byc010id#
	</select>

	<insert id="po010DAO.insertPom010Arr" parameterClass="java.util.HashMap">
	insert into ismpom010 (
		pom010id,
		odm010id, orderno, orderdate, cum010id, cum030id, byc010id, orderuser, orderusercontact,
		rcvuser,
		rcvusercontact,
		orderitemid, orderitemopt, orderitemqty, orderitemprice, postno, address, dlvmemo, dlvprice, dlvno, dlvco,
		dlvstatus, processdate, accountcum, accountbuy, status, cstype, uploadfilename, claimstatus, claimreason, retstatus, retqty,
		retprice, orderitemname, rcvusercontacthp, rcvuseremail, ordermemo, regid, poshoptype
	) (select
		#poNum#,
		odm010id, orderno, orderdate, cum010id, cum030id, #byc010id#, orderuser, orderusercontact,
		IF(#addorderuser# = 'Y', concat(rcvuser, '(보내는 사람 : ',orderuser,')'),rcvuser),
		rcvusercontact,
		orderitemid, orderitemopt, orderitemqty, orderitemprice, postno, address, dlvmemo, dlvprice, dlvno, dlvco,
		dlvstatus, processdate, accountcum, accountbuy, status, cstype, uploadfilename, claimstatus, claimreason, retstatus, retqty,
		retprice, orderitemname, rcvusercontacthp, rcvuseremail, #ordermemo#, #regid#, #pocotype#
	     from ismodm010
	    where odm010id in
		<iterate  property="odm010idArr" open="(" close=")" conjunction=",">
        #odm010idArr[]#
    	</iterate>
	)
	</insert>
	
    <select id="po010DAO.selectPom010List" parameterClass="ismpom010VO" resultClass="ismpom010VO">
	select a.pom010id, a.odm010id, a.orderno, DATE_FORMAT(a.orderdate,'%Y-%m-%d') as orderdate, a.cum010id, a.cum030id, a.byc010id, a.orderuser, a.orderusercontact,
           a.rcvuser, a.rcvusercontact, d.orderitemid, a.orderitemopt, a.orderitemqty, a.orderitemprice, a.postno, a.address,
           a.dlvmemo, a.dlvprice, a.dlvno, a.dlvco, a.dlvstatus, DATE_FORMAT(a.processdate,'%Y-%m-%d') as processdate, a.accountcum, a.accountbuy, a.status, a.cstype, 
           a.uploadfilename, a.claimstatus, a.claimreason, a.retstatus, a.retqty, a.retprice, e.salecode as byccode, e.itembuyprice as orderitembyprice, e.itemname as orderitemname, 
           d.cumprodcode, c.shopmallname, a.rcvusercontacthp, a.rcvuseremail, a.ordermemo, b.coname, e.itemname
    from ismpom010 a, ismcum010 b, ismcum030 c, ismcum040 d , ismprd010 e
    where a.cum010id = b.cum010id
       and a.cum030id = c.cum030id
       and d.cumprodcode = a.orderitemid
	   and a.orderitemopt = d.cumprodoptnm1
	   and d.orderitemid = e.itemcode
		<isNotEmpty prepend="AND" property="pom010id">
           a.pom010id = #pom010id#
        </isNotEmpty>
    order by a.orderdate, a.orderno
    </select>
    
    <insert id="po010DAO.insertPol010" parameterClass="ismpol010VO">
    insert into ismpol010 (poo010id,   pocotype,   uploaddate)
                   values (#poo010id#, #pocotype#, now())
    </insert>
    
    <!-- 발주 목록 select -->
    <select id="po020DAO.selectPoList" resultClass="ismpom020VO">
    SELECT
		@ROWNUM := @ROWNUM + 1 AS SORTNO
		, a.processdate
		, a.bycname
		, a.bycusername
		, a.regid
		, a.uploadfilename
		, a.status
		, a.rcvuseremail
		, a.receivetype
	FROM (
		SELECT 
			MAX(processdate) as processdate
			, CASE b.poshoptype
				WHEN 'B' THEN (select bycname from ismbyc010 where byc010id = b.byc010id )
				WHEN 'W' THEN (select whsname from ismwhs010 where whs010id = b.byc010id )
				ELSE '-'
			END bycname
			, bycusername
			, regid
			, IF(uploadfilename='', 'NO_FILE', uploadfilename) uploadfilename
			, CASE b.status
				WHEN 1 THEN '출고전'
				WHEN 2 THEN '출고대기'
				WHEN 3 THEN '출고완료'
				WHEN 4 THEN '출고지연'
				ELSE '반품취소'
			END status
			, rcvuseremail
			, receivetype
		FROM  ismpom010 b
		WHERE 1 = 1
		<isNotEmpty prepend="AND" property="dtSearch_frPoDt">
		<![CDATA[
        	DATE_FORMAT(IF(b.processdate = '', curdate(), DATE_ADD(b.processdate, INTERVAL 0 DAY)),'%Y-%m-%d') >= #dtSearch_frPoDt#
        ]]>
        </isNotEmpty>
        
		<isNotEmpty prepend="AND" property="dtSearch_toPoDt">
		<![CDATA[
        	DATE_FORMAT(IF(b.processdate = '', curdate(), DATE_ADD(b.processdate, INTERVAL 0 DAY)),'%Y-%m-%d') <= #dtSearch_toPoDt#
        ]]>
        </isNotEmpty>
        
        <isNotEmpty prepend="AND" property="dtSearch_bycNm">
           b.byc010id = #dtSearch_bycNm# 
		</isNotEmpty>
        
        <isNotEmpty prepend="AND" property="dtSearch_sndNm">
           b.bycusername = #dtSearch_sndNm#
        </isNotEmpty>
		GROUP BY uploadfilename, bycname, bycusername, regid, status, rcvuseremail, receivetype
		ORDER BY uploadfilename ASC
	) a, (SELECT @ROWNUM := 0) R
	ORDER BY SORTNO DESC
	LIMIT #recordCountPerPage# OFFSET #firstIndex#
    </select>

	<select id="po020DAO.selectPoListTotCnt" parameterClass="ismpomsearch020VO" resultClass="int">
	SELECT 
		count(*)
	FROM (
			SELECT 
				@ROWNUM := @ROWNUM + 1 AS SORTNO
				, DATE_FORMAT(a.PROCESSDATE, '%Y-%m-%d %H:%i' ) AS PROCESSDATE
				, (select bycname from ismbyc010 where byc010id =a.byc010id ) bycname
				, a.bycusername
				, a.regid
			FROM ismpom010 a, (SELECT @ROWNUM := 0) R
			WHERE 1 = 1
	        <isNotEmpty prepend="AND" property="dtSearch_frPoDt">
			<![CDATA[
	        	DATE_FORMAT(IF(a.PROCESSDATE = '', curdate(), DATE_ADD(a.PROCESSDATE, INTERVAL 0 DAY)),'%Y-%m-%d') >= #dtSearch_frPoDt#
	        ]]>
	        </isNotEmpty>
	        
			<isNotEmpty prepend="AND" property="dtSearch_toPoDt">
			<![CDATA[
	        	DATE_FORMAT(IF(a.PROCESSDATE = '', curdate(), DATE_ADD(a.PROCESSDATE, INTERVAL 0 DAY)),'%Y-%m-%d') <= #dtSearch_toPoDt#
	        ]]>
	        </isNotEmpty>
	        
	        <isNotEmpty prepend="AND" property="dtSearch_bycNm">
	           a.byc010id = #dtSearch_bycNm# 
			</isNotEmpty>
	        
	        <isNotEmpty prepend="AND" property="dtSearch_sndNm">
	           a.bycusername = #dtSearch_sndNm#
	        </isNotEmpty>
			GROUP BY uploadfilename, bycname, a.bycusername, a.regid
		) PO
	</select>
	
	<update id="po010DAO.updatePom010" parameterClass="java.util.HashMap">
	update ismpom010 set uploadfilename = #uploadfilename#, rcvuseremail = #rcvuseremail#, receiveType = #receiveType#,
		bycusername = (select bycusername from ismbyc020 where byc010id = #byc010id# and bycuseremail = #rcvuseremail# )
	 where pom010id = #poNum#
	</update>
	
	    <!-- 매입처 담당자 목록 select -->
    <select id="po020DAO.selectByc020List" parameterClass="String" resultClass="ismbyc020VO">
	select byc020id, byc010id, bycusername, bycusertel, bycuseremail, bycmemo
      from ismbyc020
     where byc010id = #bycId#
    </select>
	
</sqlMap>